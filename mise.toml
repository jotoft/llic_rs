[env]
RUSTFLAGS = "-C target-cpu=native"

[tasks.bench]
description = "Run all benchmarks"
run = "cargo bench"

[tasks."bench:256"]
description = "Run 256x256 benchmarks only"
run = "cargo bench -- '256x256'"

[tasks."bench:rust"]
description = "Run Rust-only benchmarks"
run = "cargo bench -- 'rust'"

[tasks.profile]
description = "Generate flamegraph + perf.data for Rust 256x256 decompression"
run = "cargo flamegraph --bench llic_benchmark -- --bench 'rust/256x256'"

[tasks."profile:report"]
description = "Show perf report from existing perf.data (run 'profile' first)"
run = "perf report --stdio -g none --percent-limit 1 2>/dev/null | head -60"

[tasks."profile:open"]
description = "Open flamegraph.svg in browser (run 'profile' first)"
run = "xdg-open flamegraph.svg 2>/dev/null || open flamegraph.svg"

[tasks."profile:all"]
description = "Profile, show report, and open flamegraph"
depends = ["profile"]
run = """
perf report --stdio -g none --percent-limit 1 2>/dev/null | head -40
echo ""
echo "Opening flamegraph.svg..."
xdg-open flamegraph.svg 2>/dev/null || open flamegraph.svg
"""

[tasks.test]
description = "Run all tests"
run = "cargo test"

[tasks.clean]
description = "Clean build artifacts and profiling data"
run = "cargo clean && rm -f flamegraph.svg perf.data perf.data.old"

[tasks."bench:pgo"]
description = "Run benchmarks with Profile-Guided Optimization"
run = """
echo "Step 1: Building with instrumentation..."
rm -rf /tmp/pgo-data && mkdir -p /tmp/pgo-data
RUSTFLAGS="-C target-cpu=native -Cprofile-generate=/tmp/pgo-data" cargo bench -- 'rust/256x256' 2>&1 | tail -10

echo "Step 2: Merging profile data..."
llvm-profdata merge -o /tmp/pgo-data/merged.profdata /tmp/pgo-data/*.profraw

echo "Step 3: Rebuilding with PGO..."
cargo clean -p llic_rs2
RUSTFLAGS="-C target-cpu=native -Cprofile-use=/tmp/pgo-data/merged.profdata" cargo bench -- 'rust/256x256'
"""

# WASM build tasks
[tasks."wasm:build"]
description = "Build WASM npm package for web (ES modules) with SIMD"
env = { RUSTFLAGS = "-C target-feature=+simd128" }
run = "wasm-pack build --target web --no-default-features --features wasm"

[tasks."wasm:build:no-simd"]
description = "Build WASM without SIMD (for older browsers)"
env = { RUSTFLAGS = "" }
run = "wasm-pack build --target web --no-default-features --features wasm"

[tasks."wasm:build:nodejs"]
description = "Build WASM npm package for Node.js with SIMD"
env = { RUSTFLAGS = "-C target-feature=+simd128" }
run = "rm -rf pkg && wasm-pack build --target nodejs --no-default-features --features wasm && mv pkg pkg-node"

[tasks."wasm:build:bundler"]
description = "Build WASM npm package for bundlers (webpack, etc) with SIMD"
env = { RUSTFLAGS = "-C target-feature=+simd128" }
run = "rm -rf pkg && wasm-pack build --target bundler --no-default-features --features wasm && mv pkg pkg-bundler"

[tasks."wasm:dev"]
description = "Build WASM with debug info for development"
env = { RUSTFLAGS = "" }
run = "wasm-pack build --dev --target web --no-default-features --features wasm"

[tasks."wasm:release"]
description = "Build optimized WASM npm package for all targets with SIMD"
env = { RUSTFLAGS = "-C target-feature=+simd128" }
run = """
echo "Building for web..."
wasm-pack build --release --target web --no-default-features --features wasm
cp -r pkg pkg-web
echo "Building for Node.js..."
wasm-pack build --release --target nodejs --no-default-features --features wasm
mv pkg pkg-node
echo "Building for bundlers..."
wasm-pack build --release --target bundler --no-default-features --features wasm
mv pkg pkg-bundler
mv pkg-web pkg
echo "Done! Packages in: pkg/, pkg-node/, pkg-bundler/"
"""

[tasks."wasm:clean"]
description = "Clean WASM build artifacts"
run = "rm -rf pkg pkg-node pkg-bundler pkg-web"

# Demo tasks
[tasks."demo:setup"]
description = "Install demo dependencies and build WASM"
depends = ["wasm:build"]
run = """
cd demo && npm install
rm -rf pkg && ln -s ../pkg pkg
"""

[tasks."demo:dev"]
description = "Run demo dev server"
depends = ["demo:setup"]
run = "cd demo && npm run dev"

[tasks."demo:build"]
description = "Build demo for production"
depends = ["demo:setup"]
run = """
cd demo
rm -rf pkg && cp -r ../pkg pkg
npm run build
rm -rf pkg
"""
